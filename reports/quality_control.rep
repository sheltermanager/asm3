Quality Control
###
Auditing
###
34702/PostgreSQL rev16
###
[Karen Waldroff] QC report, checks for common keying mistakes like adopting to rescues instead of transfers, bad state codes, etc. Customization Required.
###
en
###
-- SEE INSTRUCTION SECTION BELOW FOR INSTRUCTIONS ON HOW TO CONFIGURE FOR YOUR RESCUE/SHELTER
--
-- CHANGES MADE LOG:
-- 2023-09-05 (13) - Added check for last name on second person for Couples (P006), Modified P008 to only review initial characters, Modified A053 to only check non-archived vaccinations.
-- 2024-01-04 (13) - #A041. Bug fix to HW_FOLLOWUP that was missing old due dates.
-- 2024-01-10 (13) - Added new $USE_ENTRY_TYPE$ CONST, added SQL identification numbers, #A024, A046, A047, AO48, AO49 modified to add USE_ENTRY_TYPE check, 
-- 2014-01-10 (13) - AO24, AO25, A032, A033 modified to only report for 3 days, Added #A057, A058, A059 for use with new Entry Type.
-- 2014-04-12 (14) - A011, A012, A014 modified for Asilomar changes; A020 added mediasize check; A024 added EntryType check and changed to 1 day, A025 changed to 1 day,
--                   A032 added EntryType Check and changed to 1 day, A033 changed to 1 day, A041 changed to LEFT OUTER JOIN animaltest and added ActiveMovementDate check,
--                   Added A060, P025 added USA check, P033 added 1 day check and alerts only once. CURRENT_DATE changed to '$CURRENT_DATE$' in all.
--                   Removed REQUESTED_EUTH and ASILOMAR CONSTs.
-- 2024-05-25 (15) - A001 Removed REVIEW_DATE check; A006 & A007 changed from LastChangedDate to DateBroughtIn; A008 - A013 Changed from REVIEW_DATE to LastChangedDate > 30; 
--                   A020 changed from REVIEW_DATE to CURRENT_DATE-1; A023 Added LastChangedDate check; A026 Changed 'Original Owner' to 'Owner' & 30 day check; 
--                   A032 changed from entrytypeID <> 1 to entrytypeID NOT IN (1,7); A053 changed from REVIEW_DATE to CURRENT_DATE-1; A060 changed REVIEW_DATE to 
--                   Lastchanged -30 and added NonShelterAnimal = 0; P024 Missing < on /font>; P029 text updated to reflect check.
-- 2024-10-19 (16) - A015 Updated to include '$USE_INCIDENT_COMPLETION_TIME$' Check and '$USE_INCIDENT_COMPLETION_TIME$' added to CONST section.
--                   A053, A054, A055 Modified the date checked from using DateOfVaccination to LastChangedDate.
--                   A061 Added.  Compares cost values in Vaccination Type tables against those in Animal Templates to make sure they match.
--                   P005 Updated to exclude ownerforenames < 3 characters.
--                   P010 Updated to exclude '$CITY_ALLOWED$' in all checks.
--                   P020, P022, P031, P032 Updated to check for Deceased flag.
--                   P031 Modified to exclude addresses under 8 characters to avoid matching blanks, "None", and other non-address text.
--                   P033 Modified to exclude entries under 5 characters.
--
-- ******************************************** INSTRUCTIONS **********************************************************
-- 1.  Clone this report and change name to "Quality Control (Custom) (Version)". MAKE CHANGES TO CLONED VERSION ONLY!
-- 2.  Schedule to auto run in the morning BEFORE the start of the day and set an email to qc staff.
-- 3.  Go to Settings > Options > Display > and select 'Show ID numbers when editing lookup data' > Save
-- 4.  Edit each CONST below to meet your individual system needs.  
-- 5.  Add a Person Flag and Animal Flag of 'Ignore Issues'.  This is needed to override alerts on a case-by-case basis.
-- 6.  In Settings > Document templates, make sure all your Template names end with .html (this is the only way to separate online
--     forms and document templates for the 'Online form attached to existing Person record' issue at this point.
-- 7.  There are three sections:  ANIMAL, PEOPLE, LOCAL.  Add local SQLs to LOCAL Section to make updating easier when new versions come out.
-- 8.  If you receive the error "canceling statement due to statement timeout" you will need to pull the Possible duplicate person 
--     and Duplicate Phone SQLs out of this main program and add them to their own individual report.  Just too many records to process.
-- 9.  You can QC old data by copy, pasting, and editing individual SQLs in the SQL Interface.

-- CUSTOMIZE THE CONST VALUES IN THIS SECTION ONLY TO MATCH YOUR SYSTEM.
$CONST SERVER_URL='https://us11b.sheltermanager.com'$ -- Enter your ASM server URL
$CONST OPEN_IN_TAB='blank'$ -- When reviewing report, enter 'blank' to open links in new window/tab or 'self' remain in window/tab.
$CONST REVIEW_DATE='2023-01-01'$ -- QC records entered after this date.
$CONST REQUIRE_ADOPTION_COORDINATOR='No'$ -- Does your shelter/rescue require an adoption coordinator on every animal? Yes or No.
$CONST FOSTER_BASED='No'$ -- Is this a Foster based organization? Yes or No.
$CONST FOSTER_WARN='Yes'$ -- Do you want to alert if animal is in foster care, but there isn't a note of this in bio/comments so that the public doesn't come to shelter to try to meet the animal?
$CONST ADOPTION_IDS=2$ -- Enter any (separated by commas) Payment Type ID's used for 'Adoption' type fees. (Settings > Lookup data > Payment Types)
$CONST NON_SHELTER_ANIMALTYPE_IDS=40,41$ -- If you have an 'Animal Type' for Non-Shelter Animals (including "Boarding"), enter the IDs here.  If none, enter 0.  (Settings > Lookup data > Animal Types)
$CONST DOGANIMALTYPES=11,46,63$ -- If you have 'Animal Type' records SPECIFIC only to Dogs, enter the IDs here separated by commas. Enter 0 if none. (Settings > Lookup data > Animal Types)
$CONST CATANIMALTYPES=47,65$ -- If you have 'Animal Type' records SPECIFIC only to Cats, enter the IDs here separated by commas. Enter 0 if none. (Settings > Lookup data > Animal Types)
$CONST OS_TYPE_IDS=10$ -- IDs of Owner Surrender like Animal Type OR where an owner would be entered.  For example:  Abuse, Bite Case, Police Assist, OS etc. (Settings > Lookup data > Animal Types) 0 if none.
$CONST NON_OS_TYPE_IDS=0$ -- IDs of Animal Types that should not have an owner entered. 0 if none. (Settings > Lookup data > Animal Types)
$CONST OS_ENTRY_IDS=17,40$ -- IDs of Owner Surrender like Entry Reason/Categories OR where an owner would be entered.  For example:  Abuse, Bite Case, Police Assist, OS etc. (Settings > Lookup data > Entry Reasons)
$CONST NON_OS_ENTRY_IDS=7,19$ -- IDs of Entry Reasons/Categories that should not have an owner entered. Such as Stray, Born in Shelter, etc.  0 if none. (Settings > Lookup data > Entry Reasons)
$CONST TRANSFER_IN_CATEGORY='Yes'$ -- Do you have a 'Transfer In' Entry Reason category? (Settings > Lookup data > Entry Reasons)
$CONST TRANSFER_IN_IDS=15,16$ -- If you do have a 'Transfer In' Entry Reason category, enter the IDs.  Otherwise, enter 0.
$CONST DOA_DEATH_REASON_ID=1$ -- If you have a 'Dead On arrival' Death Reason, enter the ID here. (Settings > Lookup data > Death Reasons)
$CONST EUTH_DEATH_REASON_IDS=3,5,6,7,8$ -- IDs of Death Reasons that should only be used with Euthanasia.  (Settings > Lookup data > Death Reasons)
$CONST NONEUTH_DEATH_REASON_IDS=1,2$ -- IDs of Death Reasons that should NOT be used with Euthanasia.  (Settings > Lookup data > Death Reasons)
$CONST ACO_ASSIGN='Yes'$ -- Do you wish to be alerted when an ACO is NOT assigned to an Incident?
$CONST USE_LITTERS='Yes'$ -- Do you create Litters under ASM > Edit litters?  Yes or No.
$CONST MICROCHIP='Adoption'$ -- Do you microchip your pets upon Adoption, Alter, or None.
$CONST ALL_ALTERED='Yes'$ -- Do you require that ALL animals are altered upon adoption? Yes or No.
$CONST AGE_ALTERED=185$ -- If you allow adoption w/o spay/neuter, what age is spay/neuter required (number of days)?
$CONST SCHEDULE_ALTER='No'$ -- Do you schedule/track your spay/neuters with an entry in the Medical Tab? Yes or No.
$CONST ALTER_REVIEW_DATE='2022-01-01'$ -- Check for spay/neuter on animals that were adopted after this date.
$CONST MEDICAL_NAMES='Spay/Neuter'$ -- If you schedule/track your spay/neuters with an entry in Medical, what is the name used?
$CONST BIO_BLANK='Yes'$ -- Enter 'Yes' if you wish to be notified when a published animal is missing a bio.  Enter 'No' if not.
$CONST HW_TEST='Yes'$ -- Do you test for Heartworms?  Yes or No.
$CONST HW_TEST_IDS=3$ -- IDs of Heartworm Tests IF Test Tab is used.  Otherwise, enter 0. (Settings > Lookups > Test Types)
$CONST HW_FOLLOWUP='No'$ -- Do you follow up on dogs who are HW positive AFTER adoption?  Yes or No.
$CONST FIV_TEST='No'$ -- Do you test for FIV?  Yes or No
$CONST FIV_TEST_ID=1$ -- ID of MAIN FIV Tests IF Test Tab is used.  Otherwise, enter 0. (Settings > Lookups > Test Types)
$CONST FIV_DAYS_OLD=90$ -- Number of days old that FIV Test is required.
$CONST FIV_RETEST='No'$ -- Do you retest for FIV after cats are in shelter for over 1 year?
$CONST DOGVACCINES=4,6,8,17,18,19$ -- IDs of vaccines given to dogs. (Settings > Lookupdata > Vaccination Types)
$CONST CATVACCINES=4,6,9,17,19,22$ -- IDs of vaccines given to cats. (Settings > Lookupdata > Vaccination Types)
$CONST REQUIRED_VACCINE_IDS=0$ -- Enter the IDs of vaccines that are required upon intake.  Enter both Cat and Dog vaccines.  Enter 0 if you do not want to check for this.
$CONST REQUIRED_VACC_DAYS=5$ -- Enter how many days post intake that an animal should have the required vaccines in REQUIRED_VACCINE_IDS.
$CONST RABIES_IDS=4$ -- IDs of Rabies Vaccines. (Settings > Lookups > Vaccination Types)
$CONST RECORD_RABIES_NUM='Yes'$ -- Do you record the Rabies Tag Number in the Rabies Vaccination Record?
$CONST CAPITALIZATION_RULES='Yes'$ -- Do you want to be notified if a name is in all lower case or upper case letters?
$CONST COMMON_STREET_MISSPELLINGS='Brodway','Ouchita'$ -- Enter common Street name (owner.owneraddress) misspellings for your area. CAN NOT BE TWO WORD STREET NAMES.
$CONST COMMON_CITY_MISSPELLINGS='Cavespring','Cave Springs','Lafayette'$ -- Enter common city (owner.ownertown) misspellings for your area. 
$CONST CITY_ALLOWED='Prairie du Rocher','Town and Country'$  -- Cities (owner.ownertown) with two words are checked to make sure the second word is capitalized. Enter cities allowed.
$CONST COMMON_COUNTRY_MISSPELLINGS='Canaada','Mexxico'$ -- Enter common Country (owner.ownercountry) misspellings for your area. 
$CONST COUNTRY='USA'$ -- Enter Country.  USA for United States, UK for United Kingdom.
$CONST STATE_ABBREVIATION='AR'$ -- If USA, enter your state abbreviation (owner.ownercounty field), otherwise 
$CONST ZIPCODE_STARTING_DIGIT='7'$ -- If USA, enter the first digit/character of your area's zipcode/postcode (owner.ownerpostcode).
$CONST PHONE_DIGITS=10$ -- How many digits are in your phone numbers?
$CONST DOMAINS='biz','com','edu','gov','info','me','mil','net','org','tv','uk','us'$ -- Enter email domans seen in your country.
$CONST CITATION_NUMBERS='No'$ -- Do you record your citation/code numbers in the comments field of Citation Entries?  Yes or No.
$CONST MEMBERSHIP_EXPIRATION='No'$ -- Do you record a Membership Expiration date on people flagged as Members?
$CONST COUPLE_WARN='No'$ -- Do you want to provide a 1 day warning when a person type of "Couple" is selected?  Organizations who assign citations/incidents might not want to use this due to needing to assign citations/incidents to individual people not as a Couple.
$CONST VOUCHER_ANIMAL='No'$ -- Do you want to be alerted when a voucher is created without an animal attached?
$CONST ADDITIONAL_FIELDS=0$ -- Have you added any additionalfields that link to person records?  If so enter the Additional Fields IDs. If none, enter 0.
$CONST USE_ENTRY_TYPE='Yes'$ -- Do you have 'Show the entry type field' selected in Settings > Options > Add Animal?
$CONST USE_INCIDENT_COMPLETION_TIME='Yes'$ -- Do you want incidents with missing completion times to show on report?
-- DO NOT MODIFY PAST THIS POINT UNLESS YOU ARE FAMILIAR WITH SQL.

SELECT * FROM
(

--****************************************************************************************************************************************************************************************
--*****  ANIMAL SECTION  ******************************************************************************************************************************************************************
--****************************************************************************************************************************************************************************************
  
--#A001. Adoption Coordinator is not entered.  This is for organizations that require an Adoption Coordinator on every animal.  
SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Adoption Coordinator not assigned in Entry Section. (A001)' AS issue 
FROM animal
WHERE $REQUIRE_ADOPTION_COORDINATOR$ = 'Yes'
  AND animal.archived = 0
  AND animal.nonshelteranimal = 0
  AND animal.adoptioncoordinatorid = 0
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A002. An Adoption Movement was entered for a person record flagged as 'Other Shelter'.
--Probably should be a Transfer Movement.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  adoption.movementdate AS issuedate,
  '<font color = "Red">Adoption was entered for a record flagged as <i>Shelter</i>.  Should be Transfer Movement. Alerts Only Once. (A002)</font>' AS issue
FROM animal
  INNER JOIN adoption on adoption.id = animal.activemovementid
  INNER JOIN owner on owner.id = adoption.ownerid
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
WHERE animal.nonshelteranimal = 0
  AND date_trunc('day', animal.LastChangedDate) = '$CURRENT_DATE-1$'
  AND adoption.movementtype = 1
  AND (owner.AdditionalFlags LIKE 'shelter|%' OR owner.AdditionalFlags  LIKE '%|shelter|%')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A003. This checks to see if there is a corresponding Adoption Movement for any 
--Adoption payments entered.  Sometimes people will delete an Adoption Movement
--instead of just entering an Adoption Return Date.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  od.date AS issuedate,
   '<font color = "Red">Adoption payment recorded, but Adoption movement missing. Alerts Only Once. (A003)</font>' AS issue
FROM ownerdonation od
  LEFT OUTER JOIN owner o ON od.OwnerID = o.ID
  INNER JOIN animal ON od.AnimalID = animal.ID
WHERE date_trunc('day', animal.LastChangedDate) = '$CURRENT_DATE-1$'
  AND od.donationtypeid in ($ADOPTION_IDS$)
  AND NOT EXISTS(SELECT ID FROM adoption WHERE OwnerID = od.ownerid OR ReturnedByOwnerID = od.ownerid)

--#A004. This looks for the word 'foster' in the animal bio so that the public knows not to come to the shelter to meet an animal.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Animal in foster home without note to the public in the bio (Notes section > Description). (A004)' AS issue
FROM animal
  INNER JOIN media ON media.LINKID = animal.id
WHERE $FOSTER_BASED$ = 'No'
  AND $FOSTER_WARN$ = 'Yes'
  AND animal.Archived = 0
  AND animal.isnotavailableforadoption = 0
  AND animal.activeMovementType=2
  AND animal.haspermanentfoster = 0
  AND media.websitephoto = 1 
  AND NOT (animal.animalcomments LIKE '%foster%' OR animal.animalcomments LIKE '%Foster%')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A005. Compares Animal Type with Species.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Animal with wrong <i>Animal Type</i> based on Species. (A005)' AS issue
FROM animal
INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE animal.NonShelterAnimal = 0
  AND animal.archived = 0
  AND ((Species.SpeciesName = 'Dog' AND animal.animaltypeid IN ($CATANIMALTYPES$))
  OR (Species.SpeciesName = 'Cat' AND animal.animaltypeid IN ($DOGANIMALTYPES$)))
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  
--#A006.  Compares Non-Shelter Animal Type with Non-Shelter Flag.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.DateBroughtIn) AS issuedate,
  '<font color = "Red">Animal with mis-matched Non-Shelter <i>Animal Type</i> and <i>Non-Shelter</i>. Alerts Only Once. (A006)</font>' AS issue
FROM animal
WHERE NULLIF(regexp_replace('$NON_SHELTER_ANIMALTYPE_IDS$', '\D','','g'), '')::numeric > 0
  AND animal.animalname NOT LIKE 'Template%'
  AND date_trunc('day', DateBroughtIn) = '$CURRENT_DATE-1$'
  AND ((animal.NonShelterAnimal = 0 AND animal.animaltypeid IN ($NON_SHELTER_ANIMALTYPE_IDS$))
  OR
  (animal.NonShelterAnimal = 1 AND animal.animaltypeid NOT IN ($NON_SHELTER_ANIMALTYPE_IDS$)))

--#A007. Reports when Abyssinian or Affenpinscher is selected as the Breed to catch animals with wrong breed. Added to 1/24/2023
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.DateBroughtIn) AS issuedate,
  '<font color = "Red">Breed issue (Possible). Abyssinian or Affenpinscher selected. Alerts Only Once. (A007)</font>' AS issue
FROM animal
WHERE date_trunc('day', DateBroughtIn) = '$CURRENT_DATE-1$'
  AND (BreedName like '%Abyssinian%' OR BreedName like '%Affenpinscher%')
  AND animal.animalname NOT LIKE 'Template%'

--#A008. Days on Shelter should = 0 if DOA checkbox is checked.  Added 8/12/2021
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
    '<font color="red">Death issue.  Days on Shelter should equal 0 if <i>Dead on arrival</i> Checkbox is selected. Alerts for 30 Days. (A008)</font>' AS issue
FROM animal
WHERE DeceasedDate is not null
  AND animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND IsDOA = 1 and DaysOnShelter <> 0
  AND NonShelterAnimal = 0
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A009. Euthanized and DOA should not both be checked.  DOA means dead before
--animal entered shelter.  Added 8/12/21
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
    '<font color="red">Death issue.  DOA and Euthanized should not both be selected. Alerts for 30 Days. (A009)</font>' AS issue
FROM animal
WHERE animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND DECEASEDDATE is not null
  AND (animal.IsDOA = 1 AND animal.Puttosleep = 1
  OR animal.IsDOA = 1 AND animal.AsilomarOwnerRequestedEuthanasia = 1)  

--#A010. Invalid death reason with DOA Issue.  Added 8/12/21
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
    '<font color="red">Death issue.  DOA Category and DOA Checkbox should match. Alerts for 30 Days. (A010)</font>' AS issue
FROM animal
WHERE $DOA_DEATH_REASON_ID$ > 0
  AND animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND DECEASEDDATE is not null
  AND (animal.IsDOA = 1 AND animal.PTSReasonID <> $DOA_DEATH_REASON_ID$
  OR animal.IsDOA = 0 AND animal.PTSReasonID = $DOA_DEATH_REASON_ID$)

--#A011. Euthanasia check box not selected.  Added 8/12/21
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
    '<font color="red">Death issue.  <i>Euthanized</i> Checkbox needs to be selected. Alerts for 30 Days. (A011)</font>' AS issue
FROM animal
WHERE animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND PutToSleep = 0
  AND DECEASEDDATE is not null
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  AND PTSReasonID IN ($EUTH_DEATH_REASON_IDS$)
  --AND (($ASILOMAR$='No' AND PTSReasonID IN ($EUTH_DEATH_REASON_IDS$))
  --	OR
  --    ($ASILOMAR$='Yes' AND PTSReasonID IN ($EUTH_DEATH_REASON_IDS$) AND PTSReasonID NOT IN ($REQUESTED_EUTH$) AND AsilomarOwnerRequestedEuthanasia = 0))  

--#A012. Invalid death reason with euthanasia check box selected. Added 8/12/21
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
  '<font color="red">Death issue.  Invalid Death Reason for selected <i>Euthanized</i> box. Alerts for 30 Days. (A012)</font>' AS issue
FROM animal
WHERE animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND animal.PutToSleep = 1
  AND animal.PTSReasonID IN ($NONEUTH_DEATH_REASON_IDS$)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%') 

--#A013. Alerts when an animal has been marked as either euthanized or DOA, but then the 
--Death date later removed.  The euthanized or DOA fields need to be cleared out.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">Death issue.  Marked deceased without Deceased Date.  Enter temp Deceased Date, clear deceased reason, then re-Save. Alerts for 30 Days. (A013)</font>' AS issue
FROM animal
WHERE animal.LastChangedDate > '$CURRENT_DATE-30$'
  AND (puttosleep = 1 OR diedoffshelter = 1 OR isdoa = 1)
  AND deceaseddate IS NULL
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A014. Euthanasia check box not selected.  Added 6/9/2023. 4/11/2024 No longer needed with new "Owner requested euthanasia" Entry Type
--UNION SELECT
--  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
--  animal.sheltercode as code,
--  date(animal.LastChangedDate) as issuedate,
--    'Death issue.  <i>Owner requested euthanasia</i> Checkbox needs to be selected. (A014)' AS issue
--FROM animal
--WHERE animal.LastChangedDate >= $REVIEW_DATE$
--  AND $ASILOMAR$='Yes'
--  AND PutToSleep = 0
--  AND PTSReasonID in ($REQUESTED_EUTH$)
--  AND AsilomarOwnerRequestedEuthanasia = 0
--  AND DECEASEDDATE is not null
--  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')   

--#A015. Reports when AC Incident Completion Time is not entered.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/incident?id=' || ac.ID ||'" target="_'||$OPEN_IN_TAB$||'">'|| ti.IncidentName||'</a>' AS Name,
  CAST (ac.iD AS text) AS code,
  date(ac.CompletedDate) AS issuedate,
'<font color="red">Incident issue. Completion Time not entered. Alerts Only Once. (A015)</font>' AS issue
FROM animalcontrol ac
LEFT OUTER JOIN incidenttype ti ON ti.ID = ac.IncidentTypeID
LEFT OUTER JOIN incidentcompleted ci ON ci.ID = ac.IncidentCompletedID
WHERE $USE_INCIDENT_COMPLETION_TIME$ = 'Yes'
  AND ac.CompletedDate::time = '00:00:00'
  AND date_trunc('day', ac.CompletedDate) = current_date -1  
  
--#A016. Reports when AC Incident Completion Type is not entered.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/incident?id=' || ac.ID ||'" target="_'||$OPEN_IN_TAB$||'">'|| ti.IncidentName||'</a>' AS Name,
  CAST (ac.iD AS text) AS code,
  date(ac.CompletedDate) AS issuedate,
  '<font color="red">Incident issue. Completion Type not entered. Alerts Only Once. (A016)</font>' AS issue
FROM animalcontrol ac
LEFT OUTER JOIN incidenttype ti ON ti.ID = ac.IncidentTypeID
LEFT OUTER JOIN incidentcompleted ci ON ci.ID = ac.IncidentCompletedID
WHERE  ac.IncidentCompletedID = 0
  AND CompletedDate Is Not Null  
  AND date_trunc('day', ac.LastChangedDate) = '$CURRENT_DATE-1$'  

--#A017. Reports when AC Incident doesn't have an officer Assigned.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/incident?id=' || ac.ID ||'" target="_'||$OPEN_IN_TAB$||'">'|| ti.IncidentName||'</a>' AS Name,
  --ti.IncidentName AS name,
  CAST (ac.iD AS text) AS code,
  date(ac.IncidentDateTime) AS issuedate,
'<font color="red">Incident issue. Officer not assigned. Alerts Only Once. (A017)</font>' AS issue
FROM animalcontrol ac
LEFT OUTER JOIN incidenttype ti ON ti.ID = ac.IncidentTypeID
LEFT OUTER JOIN incidentcompleted ci ON ci.ID = ac.IncidentCompletedID
WHERE $ACO_ASSIGN$ = 'Yes'
  AND date_trunc('day', ac.IncidentDateTime) = '$CURRENT_DATE-1$'
  AND ac.DispatchedACO = ''
  AND ac.CompletedDate IS NULL
  
--#A018. AAlerts when an litter name was added to an animal, but a litter was not added in Edit Litters
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Litter Name added to animal, but Litter not created in ASM > Edit litters. (A018)' AS issue
FROM animal
WHERE $USE_LITTERS$ = 'Yes'
  AND animal.archived = 0
  AND AcceptanceNumber <> '' 
  AND NOT EXISTS(select ID FROM animallitter al WHERE al.acceptancenumber = animal.acceptancenumber)

--#A019. Alerts when litter date does not match animal datebroughtin.  This is a good indication of a duplicate litter name.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animallitter.Date) AS issuedate,
  '<font color = "red"><i>' || animallitter.AcceptanceNumber || '</i> Litter Start date (' || date(animallitter.Date) || ') does not match Animal <i>Date Brought In</i> (' || date(animal.DateBroughtIn) || '). Modify in <i>ASM > Edit litters</i>  Alerts Only Once. (A019)</font>' as issue
FROM animal
INNER JOIN animallitter ON animallitter.AcceptanceNumber = animal.acceptancenumber
WHERE animal.NONSHELTERANIMAL = 0 
  AND date_trunc('day', animallitter.Date) = '$CURRENT_DATE-1$'
  AND animal.archived = 0
  AND date(animal.DateBroughtIn) <> date(animallitter.Date)
  AND animal.id <> animallitter.ParentAnimalID
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  
--#A020. Checks for Media with default name of New document.  Added 11/5/2021
UNION SELECT   
  'See Code to search' as name,
  CASE WHEN linktypeid = 0 THEN (SELECT sheltercode FROM animal a WHERE linkID = a.id)
   WHEN linktypeid = 1 THEN (SELECT 'Lost Animal ' || TO_CHAR(ID, '000000') FROM animallost al WHERE linkID = al.id)
   WHEN linktypeid = 2 THEN (SELECT 'Found Animal ' || TO_CHAR(ID, '000000') FROM animalfound af WHERE linkID = af.id)
   WHEN linktypeid = 3 THEN (SELECT ownercode FROM owner o WHERE linkID = o.id)
   WHEN linktypeid = 5 THEN (SELECT 'Waitlist ' || TO_CHAR(ID, '000000') FROM animalwaitinglist aw WHERE linkID = aw.id)
   WHEN linktypeid = 6 THEN (SELECT 'AC Incident ' || TO_CHAR(ID, '000000') FROM animalcontrol ac WHERE linkID = ac.id)
   END AS code,
  date(media.createddate) AS issuedate,
  '<font color="red">Media Issue.  Rename document or delete blank <i>New document</i>. Alerts Only Once. (A020)</font>' AS issue
FROM media
WHERE medianotes = 'New document'
  AND MEDIASIZE = 0
  AND media.createddate = '$CURRENT_DATE-1$'

--#A021. Alerts when adopted and marked microchip, but no microchip number entered.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Microchip issue.  Marked <i>Microchipped</i> but no number in Health and Identification section. <font color = "Red">Alerts for 3 days.</font> (A021)' AS issue 
FROM animal
WHERE $MICROCHIP$ = 'Yes'
  AND animal.deceaseddate is null
  AND animal.Identichipped = 1 
  AND animal.Identichipnumber = ''
  AND NOT animal.ActiveMovementType = 5
  AND animal.activemovementdate > '$CURRENT_DATE-3$'
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A022. Alerts when an animal is adopted or altered, but hasn't been microchipped.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.LastChangedDate AS issuedate,
  'Microchip issue.  Not Microchipped. <font color = "Red">Alerts for 3 days.</font> (A022)' AS issue 
FROM animal
INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE animal.LastChangedDate > '$CURRENT_DATE-3$'
  AND animal.deceaseddate IS NULL
  AND animal.NONSHELTERANIMAL = 0
  AND animal.Identichipped = 0
  AND Species.SpeciesName IN ('Dog','Cat')
  AND animal.iscourtesy = 0
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  AND (($MICROCHIP$ = 'Adoption' AND animal.activemovementtype = 1) 
       OR
      ($MICROCHIP$ = 'Alter' AND animal.Neutered = 1 AND animal.activemovementtype NOT IN (4,5,6,7))) 

--#A023. While ASM will accept - & *, if someone is searching for a microchip number, and
--enters only numbers, they will not find these records. Better to stay consistent.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">Microchip Number invalid.  Remove - or *. Alerts Only Once. (A023)</font>' AS issue
FROM animal
WHERE date_trunc('day', animal.LastChangedDate) = '$CURRENT_DATE-1$'
  AND ((animal.identichipnumber LIKE '%*%' OR animal.identichipnumber LIKE '%-%')
  OR (animal.identichip2number LIKE '%*%' OR animal.identichip2number LIKE '%-%'))
  AND animal.IsNotForRegistration = 0
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A024. Reports when Entry Category indicates Owner Surrender, but no owner
--entered in Original Owner field.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">No Owner in <i>Original Owner</i> field in Entry section even though designated owner surrender type in Entry Category or Entry Type. Alerts Only Once. (A024)</font>' AS issue
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $USE_ENTRY_TYPE$ = 'No'
  AND animal.DateBroughtIn = '$CURRENT_DATE-1$'
  AND animal.archived=0
  AND animal.originalownerid = 0
  AND (animal.entryreasonid IN ($OS_ENTRY_IDS$) OR animal.entrytypeID = 1)
  AND animal.istransfer = 0
  AND animal.reasonno = '' -- make sure a Reason not from owner wasn't entered
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A025. Reports when Animal Type indicates Owner Surrender, but no owner
--entered in Original Owner field.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">No Owner in <i>Original Owner</i> field in Entry section even though designated an owner surrender Animal Type. Alerts Only Once. (A025)</font>' AS issue
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE animal.DateBroughtIn = '$CURRENT_DATE-1$'
  AND animal.archived=0
  AND animal.originalownerid = 0
  AND animal.animaltypeid IN ($OS_TYPE_IDS$)
  AND animal.istransfer = 0
  AND animal.reasonno = '' -- make sure a Reason not from owner wasn't entered
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')    
  
--#A026. Reports when an owner is not entered for a Non-Shelter animal.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.DateBroughtIn) AS issuedate,
  '<font color = "Red">No Owner in <i>Owner</i> field in Entry section on Non-Shelter animal. Alerts for 30 days. (A026)</font>' AS issue 
FROM animal
WHERE animal.deceaseddate IS NULL
  AND animal.NONSHELTERANIMAL = 1 
  AND animal.ORIGINALOWNERID = 0
  AND NOT animal.animalname LIKE 'Template%'
  AND animal.datebroughtin > '$CURRENT_DATE-30$'
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  
--#A027. Reports when a Non-Shelter Flag is added to an animal with an active movement. Added 2/9/2022
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color = "Red"><i>Non-Shelter</i> Flag added to animal with an active movement. Alerts Only Once. (A027)</font>' AS issue
FROM animal
WHERE date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND nonshelteranimal = 1 
  AND activemovementtype > 0

--#A028. Reports animals adopted but not altered. 
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
    'Not altered but adopted. (A028)' AS issue
FROM animal
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
  INNER JOIN adoption ON adoption.ID = animal.activemovementID
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $ALL_ALTERED$ = 'Yes'
  AND $SCHEDULE_ALTER$ = 'No'
  AND animal.deceaseddate IS NULL
  AND animal.nonshelteranimal = 0
  AND animal.activemovementtype = 1
  AND animal.activemovementdate >= $ALTER_REVIEW_DATE$
  AND animal.Neutered = 0
  AND adoption.ISTRIAL = 0
  AND Species.SpeciesName IN ('Dog','Cat')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')  
  
--#A029. Reports animals adopted but not altered AFTER A CERTAIN AGE. 
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
    'Not altered but adopted. (A029)' AS issue
FROM animal
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
  INNER JOIN adoption ON adoption.ID = animal.activemovementID
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $ALL_ALTERED$ = 'No'
  AND $SCHEDULE_ALTER$ = 'No'
  AND animal.deceaseddate IS NULL
  AND animal.nonshelteranimal = 0
  AND animal.activemovementtype = 1
  AND animal.activemovementdate > $ALTER_REVIEW_DATE$
  AND animal.Neutered = 0
  AND adoption.ISTRIAL = 0
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= $AGE_ALTERED$
  AND Species.SpeciesName IN ('Dog','Cat')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A030. Reports animals adopted but not altered AFTER A CERTAIN AGE if you set a spay/neuter due date in Medical. Added 8/12/2021
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode as code,
  animal.activemovementdate AS issuedate,
    'Not altered but adopted.  Spay/Neuter due date not entered in Medical or past due. (A030)' AS issue
FROM animal
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
  INNER JOIN adoption ON adoption.ID = animal.activemovementID
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $SCHEDULE_ALTER$ = 'Yes'
  AND animal.deceaseddate is null
  AND animal.activemovementtype = 1
  AND animal.activemovementdate >= $ALTER_REVIEW_DATE$
  AND animal.Neutered = 0
  AND adoption.ISTRIAL = 0
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= $AGE_ALTERED$
  AND Species.SpeciesName IN ('Dog','Cat')
  AND (NOT EXISTS(SELECT animalmedical.ID FROM animalmedical INNER JOIN animalmedicaltreatment amt ON amt.animalmedicalid = animalmedical.ID WHERE animalmedical.AnimalID = animal.ID AND animalmedical.TreatmentName IN ($MEDICAL_NAMES$))
       OR
    EXISTS(SELECT animalmedical.ID FROM animalmedical INNER JOIN animalmedicaltreatment amt ON amt.animalmedicalid = animalmedical.ID WHERE animalmedical.AnimalID = animal.ID AND animalmedical.TreatmentName IN ($MEDICAL_NAMES$) AND amt.DateRequired < current_date -1)) 
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%') 

--#A031. Compares current owner (animal.ownerid with adoption.ownerid) to see if maybe
--someone changed this field instead of creating a movement.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
   date(animal.LastChangedDate) AS issuedate,
   '<font color = "Red"><i>Owner</i> field in Details Section has changed.  Be sure that this was not changed instead of creating a Movement.  This should only be used when an <b>adopter</b> re-homes an animal and you do not wish to track that Movement. Alerts Only Once. (A031)</font>' AS issue
FROM animal
INNER JOIN adoption ON adoption.id = animal.activemovementid
WHERE date_trunc('day', animal.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND animal.ownerid <> adoption.ownerid
  AND adoption.MovementType = 1
  AND adoption.istrial = 0
  AND adoption.ReturnDate IS NULL
  AND animal.deceasedDate IS NULL

--#A032. Reports when Entry Category indicates NOT Owner Surrender, but an owner is entered in Original Owner field.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">Person in <i>Original Owner</i> field in Entry section even though designated as a non-owned Entry Category or Entry Type. Alerts Only Once. (A032)</font>' AS issue 
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE animal.DateBroughtIn = '$CURRENT_DATE-1$'
  AND animal.archived = 0
  AND animal.nonshelteranimal = 0
  AND NOT animal.originalownerid = 0
  AND animal.istransfer = 0
  AND animal.IsPickup = 0
  AND (animal.entryreasonid IN ($NON_OS_ENTRY_IDS$) OR animal.entrytypeID NOT IN (1,7))
  AND animal.reasonno = '' -- make sure a Reason not from owner wasn't entered
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A033. Reports when Animal Type indicates NOT Owner Surrender, but an owner is entered in Original Owner field.  
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color="red">Person in <i>Original Owner</i> field in Entry section even though designated as a non-owned Animal Type. Alerts Only Once. (A033)</font>' AS issue 
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE animal.DateBroughtIn = '$CURRENT_DATE-1$'
  AND animal.archived = 0
  AND animal.nonshelteranimal = 0
  AND NOT animal.originalownerid = 0
  AND animal.istransfer = 0
  AND animal.animaltypeid IN ($NON_OS_TYPE_IDS$)
  AND animal.IsPickup = 0
  AND animal.reasonno = '' -- make sure a Reason not from owner wasn't entered
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')  
  
--#A034.  Looks for Alerts in the publishing logs.
UNION SELECT
  'Logs' AS name,
  'None' AS code,
  current_date AS issuedate,
      '<font color = "Red">Please review Publishing > View publishing logs > for error. Alerts Only Once. (A034)</font>' AS issue
FROM publishlog
WHERE date_trunc('day', publishlog.publishdatetime) = '$CURRENT_DATE$'
  AND ALERTS > 0
  AND LOGDATA NOT LIKE '%Got 0 matching animals for publishing%'

--#A035. Check to see if published animals have had bios written for them.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Published animal without bio in Description box (Notes section). (A035)' AS issue
FROM animal
INNER JOIN media ON media.LINKID = animal.id
WHERE $BIO_BLANK$ = 'Yes'
  AND animal.Adoptable = 1
  AND animal.animalcomments = ''  
  
--#A036. Animal's gender is not entered.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Sex not specified. (A036)' AS issue 
FROM animal
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE animal.archived = 0
  AND animal.nonshelteranimal = 0
  AND animal.deceaseddate IS NULL
  AND animal.sex = 2
  AND Species.SpeciesName IN ('Dog','Cat')
  AND EXTRACT(days FROM animal.datebroughtin - animal.dateofbirth) > 42 -- at 6weeks
   AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A037. Alters if dog hasn't been Heartworm Tested.  Uses the Health and Identification Section instead of Test Tab.
  UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Test issue. Heartworm Test needed. (A037)' AS ISSUE
FROM animal
  INNER JOIN adoption ON adoption.ID = animal.activemovementID
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $HW_TEST$ = 'Yes'
  AND  NULLIF(regexp_replace('$HW_TEST_IDS$', '\D','','g'), '')::numeric = 0
  AND animal.Archived = 0
  AND Species.SpeciesName = 'Dog'
  AND EXTRACT(days FROM animal.DateBroughtIn - animal.dateofbirth) >= 180
  AND (animal.HeartwormTested = 0 OR animal.HeartwormTestDate < CURRENT_DATE - INTERVAL '1 year')
    
--#A038. This is a TWO PART check.  This alerts when an animal was too young for a 
--heartworm test when it came in, but now is old enough.
UNION SELECT
   '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
   animal.sheltercode AS code,
   date(animal.LastChangedDate) AS issuedate,
  'Test issue.  Heartworm Test <i>Due</i> needs to be added in Test Tab. (A038)' AS issue -- this is needed for pups that reach 6m in shelter. Part 1
FROM animal
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $HW_TEST$ = 'Yes'
  AND  NULLIF(regexp_replace('$HW_TEST_IDS$', '\D','','g'), '')::numeric > 0
  AND animal.archived=0
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= 210 -- 7 months to allow for Templates
  AND Species.SpeciesName = 'Dog'
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($HW_TEST_IDS$)) 
    AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A039. This is the second part of a TWO PART check.  This alerts when an animal is older
--than a year without a heartworm test scheduled. 
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Test issue.  Heartworm Test <i>Due</i> needs to be added in Test Tab. (A039)' AS issue -- This finds tests that are older than 1 year. Part 2
FROM animal
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $HW_TEST$ = 'Yes'
  AND NULLIF(regexp_replace('$HW_TEST_IDS$', '\D','','g'), '')::numeric > 0
  AND animal.archived=0
  AND Species.SpeciesName = 'Dog'
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= 210 -- 7 months to allow for Templates
  AND EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($HW_TEST_IDS$) and animaltest.DATEOFTEST < CURRENT_DATE - INTERVAL '1 year')
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($HW_TEST_IDS$) and animaltest.DATEOFTEST >= CURRENT_DATE - INTERVAL '1 year')
 AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($HW_TEST_IDS$) and animaltest.DATEOFTEST is null)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A040. Alerts when an animal is adopted that is over 6 months and not heartworm tested.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
  'Test issue.  Not Heartworm Tested but adopted. <font color = "Red">Alerts for 3 Days Only.</font> (A040)' AS issue
FROM animal
  INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE $HW_TEST$ = 'Yes'
  AND animal.deceaseddate IS NULL
  AND animal.activemovementtype = 1
  AND animal.activemovementdate > '$CURRENT_DATE-3$'
  AND EXTRACT(days FROM animal.datebroughtin - animal.dateofbirth) > 180
  AND animal.heartwormtested = 0
  AND Species.SpeciesName = 'Dog'
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%') 
  
--#A041. This checks HW Positive Dogs for a retest date if shelter follows up on HW positive dogs.   Added 8/12/2021
--Change from 6 month TO 1 year in INTERVAL statements if needed
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) AS issuedate,
  'Test issue. Heartworm Positive dog needs to be re-tested or Heartworm Test Due needs to be added to Test Tab. (A041)' AS ISSUE
FROM animal
  INNER JOIN species ON species.ID = animal.SpeciesID
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
  LEFT OUTER JOIN animaltest ON animaltest.animalid = animal.ID
WHERE $HW_FOLLOWUP$ = 'Yes'
  AND animal.DeceasedDate IS NULL
  AND (animal.archived=0 OR (animal.activemovementtype IN (1,11) AND animal.ActiveMovementDate > '$CURRENT_DATE-730$'))
  AND animal.HeartwormTestResult = 2
  AND Species.SpeciesName = 'Dog'
  AND ((animaltest.TestTypeID IN ($HW_TEST_IDS$) and animaltest.DateRequired < CURRENT_DATE AND animaltest.DATEOFTEST is null)
       OR
      (animal.HeartwormTestDate < CURRENT_DATE - INTERVAL '1 year'
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($HW_TEST_IDS$) and animaltest.DATEOFTEST is null)))
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')  

--#A042. Alerts if a three month old cat hasn't been FIV Tested.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate, 
 'Test issue.  FIV/FLV Test needed. (A042)' AS issue
FROM animal
  INNER JOIN species ON species.ID = animal.SpeciesID
WHERE $FIV_TEST$ = 'Yes'
  AND $FIV_TEST_ID$ = 0
  AND animal.archived=0
  AND Species.SpeciesName = 'Cat'
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= $FIV_DAYS_OLD$
  AND animal.combitested = 0
    AND (animal.IsHold = 0 or animal.HoldUntilDate < '$CURRENT_DATE$')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  
--#A043. Two-part check for FIV/FLV Test
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate, 
 'Test issue.  FIV/FLV Test <i>Due</i> needs to be added in Test Tab. (A043)' AS issue -- this is needed for cats that reach 2m in shelter. Part 1
FROM animal
  INNER JOIN species ON species.ID = animal.SpeciesID
WHERE $FIV_TEST$ = 'Yes'
  AND $FIV_TEST_ID$ > 0
  AND animal.archived=0
  AND Species.SpeciesName = 'Cat'
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= $FIV_DAYS_OLD$
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($FIV_TEST_ID$)) 
   AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A044.  This catches tests older than one year.  Part 2
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Test issue.  FIV/FLV Test <i>Due</i> needs to be added in Test Tab. (A044)' AS issue -- This finds tests that are older than 1 year. Part 2
FROM animal
  INNER JOIN species ON species.ID = animal.SpeciesID
WHERE $FIV_TEST$ = 'Yes'
  AND $FIV_TEST_ID$ > 0
  AND $FIV_RETEST$ = 'Yes'
  AND Species.SpeciesName = 'Cat'
  AND animal.archived=0
  AND EXTRACT(days FROM current_date - animal.dateofbirth) >= 210 -- 7 months to allow for Templates   AND animal.speciesid = 1
  AND EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID  AND animaltest.TestTypeID IN ($FIV_TEST_ID$) and animaltest.DATEOFTEST < CURRENT_DATE - INTERVAL '1 year')
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($FIV_TEST_ID$) and animaltest.DATEOFTEST >= CURRENT_DATE - INTERVAL '1 year')
  AND NOT EXISTS(SELECT animaltest.testtypeid FROM animaltest WHERE animaltest.AnimalID = animal.ID AND animaltest.TestTypeID IN ($FIV_TEST_ID$) and animaltest.DATEOFTEST is null)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A045. Alerts for cat adoptions without FIV test
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
  'Test issue. Not FIV/FLV Tested but adopted. <font color = "Red">Alerts for 3 Days Only.</font> (A045)' AS Issue 
FROM animal
  INNER JOIN species ON species.ID = animal.SpeciesID
WHERE $FIV_TEST$ = 'Yes'
  AND animal.deceaseddate IS NULL
  AND animal.activemovementtype = 1
  AND animal.activemovementdate > '$CURRENT_DATE-3$'
  AND EXTRACT(days FROM animal.datebroughtin - animal.dateofbirth) > 60
  AND animal.CombiTested = 0
  AND Species.SpeciesName = 'Cat'
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A046. If marked 'Transfer In' , but check to see if there is a person in the 'Transferred From'
--field in the Entry Section.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Transfer In Issue. Marked <i>Transfer In</i>, but no person in <i>Transferred From</i> field in Entry section. <font color = "Red">Alerts for 3 days Only.</font> (A046)' AS issue  
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $USE_ENTRY_TYPE$ = 'No'
  AND animal.DateBroughtIn > '$CURRENT_DATE-3$'
  AND animal.nonshelteranimal = 0
  AND animal.broughtinbyownerid = 0
  AND (animal.istransfer = 1 OR animal.EntryReasonID IN ($TRANSFER_IN_IDS$))
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A047. If marked 'Transfer In' ,  check to see if person in the 'Transferred From'
--field is flagged as a Vet or Other Shelter.  Added 8/12/2021
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color = "red">Transfer In issue. Marked <i>Transfer In</i>, but person in <i>Transferred From</i> field not flagged as <i>Other Shelter or Vet</i>. Alerts Only Once.</font> (A047)' AS issue 
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
INNER JOIN owner on owner.id = animal.broughtinbyownerid
WHERE date_trunc('day', animal.DateBroughtIn) = '$CURRENT_DATE-1$'
  AND animal.nonshelteranimal = 0
  AND animal.broughtinbyownerid <> 0
  AND NOT (owner.AdditionalFlags LIKE 'shelter|%' OR owner.AdditionalFlags  LIKE '%|shelter|%' OR owner.AdditionalFlags LIKE 'vet|%' OR owner.AdditionalFlags LIKE '%|vet|%')
  AND (animal.istransfer = 1 OR animal.EntryTypeID = 3)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A048. Alerts if Entry Category set to Transfer from but 'Transfer In' box not checked. Added 8/12/21
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
  '<font color = "red">Transfer In issue. A <i>Transfer</i> Entry Category selected, but <i>Transfer In</i> checkbox not selected in Entry Section. Alerts Only Once.</font> (A048)' AS issue 
FROM animal
   INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $TRANSFER_IN_CATEGORY$ = 'Yes'
  AND $USE_ENTRY_TYPE$ = 'No'
  AND date_trunc('day', animal.DateBroughtIn) = '$CURRENT_DATE-1$'
  AND animal.nonshelteranimal = 0
  AND animal.archived = 0
  AND animal.istransfer = 0
  AND animal.entryreasonid IN ($TRANSFER_IN_IDS$)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')  
  
--#A049. Alerts if marked 'Transfer In'  but the Entry Category not set to Transfer from 
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  '<font color = "red">Transfer In issue. <i>Transfer In</i> box selected, but <i>Entry Category</i> not set to a Transfer category in Entry section. Alerts Only Once.</font> (A049)' AS issue 
FROM animal
  INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $TRANSFER_IN_CATEGORY$ = 'Yes'
  AND $USE_ENTRY_TYPE$ = 'No'
  AND date_trunc('day', animal.DateBroughtIn) = '$CURRENT_DATE-1$'
  AND animal.archived = 0
  AND animal.nonshelteranimal = 0
  AND animal.istransfer = 1
  AND animal.EntryReasonID NOT IN ($TRANSFER_IN_IDS$)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A050. Reports an animal that was transferred to a organization/person that doesn't have
--the Other Shelter flag.   This flag is needed for the 'Transfer an animal' functionality
--to work.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
   'Transfer Movement. Person record not flagged as <i>Other Shelter</i>. <font color="red">Alerts Only Once.</font>  (A050)' AS issue
FROM animal
  INNER JOIN adoption on adoption.id = animal.activemovementid
  INNER JOIN owner on owner.id = adoption.ownerid
  LEFT OUTER JOIN owner cw ON cw.ID = animal.adoptioncoordinatorID
WHERE date_trunc('day', animal.LastChangedDate) = '$CURRENT_DATE-1$'
  AND animal.nonshelteranimal = 0
  AND adoption.movementtype = 3
  AND NOT (owner.AdditionalFlags LIKE 'shelter|%' OR owner.AdditionalFlags  LIKE '%|shelter|%')
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')
  
--#A051. Alerts when animal is marked as a Trial Adoption but no trail ends on date is entered.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS Name,
  animal.sheltercode AS code,
  animal.activemovementdate AS issuedate,
  'Trial Adoption - <i>Trial ends on</i> date field is blank. (A051)' AS issue 
FROM animal
INNER JOIN adoption ON adoption.ID = animal.activemovementID
WHERE animal.deceaseddate IS NULL
  AND animal.activemovementtype = 1
  AND adoption.ISTRIAL = 1
  AND adoption.trialenddate is null

--#A052. Alerts when the Trial end date has expired.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode AS code,
  adoption.trialenddate AS issuedate,
  'Trial adoption ended.  Extend date or Uncheck <i>Trial</i> box in Movement. (A052)' AS issue
FROM animal
INNER JOIN adoption ON adoption.ID = animal.activemovementID
WHERE animal.deceaseddate IS NULL
  AND animal.activemovementtype = 1
  AND adoption.ISTRIAL = 1
  AND adoption.trialenddate < '$CURRENT_DATE$'

--#A053. Compares vaccination types with species type. 
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode AS code,
  av.DateRequired AS issuedate,
  'Vaccination issue. Animal with wrong Vaccination Type. (A053)' AS issue
FROM animal
  INNER JOIN animalvaccination av ON animal.ID = av.AnimalID
  INNER JOIN vaccinationtype v ON av.VaccinationID = v.ID
  INNER JOIN species ON species.ID = animal.SpeciesID
WHERE date_trunc('day', av.LastChangedDate) = '$CURRENT_DATE-1$'
  AND ((Species.SpeciesName='Dog' AND v.id NOT IN ($DOGVACCINES$)) OR (Species.SpeciesName='Cat' AND v.id NOT IN ($CATVACCINES$)))
  AND v.IsRetired = 0
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')  
  
--#A054. Alerts when first character of Vaccination Manufacturer is a numeric.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  animalvaccination.DateOfVaccination AS issuedate,
'Vaccination issue. Manufacturer starts With numeric. <font color="red">Alerts Only Once.</font> (A054)' AS ISSUE 
FROM animal
INNER JOIN animalvaccination ON animalvaccination.animalid = animal.id
WHERE substring(animalvaccination.Manufacturer,1,1) in ('0','1','2','3','4','5','6','7','8','9')
  AND date_trunc('day', animalvaccination.LastChangedDate) = '$CURRENT_DATE-1$'

--#A055. Checks to see if Rabies Tag is missing.  Added 8/12/2021
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  animalvaccination.DateOfVaccination AS issuedate,
  '<font color = "red">Vaccination issue.  Missing Rabies Tag Number in Vaccination Record. Alerts Only Once. (A055)</font>'  AS ISSUE 
FROM animal
INNER JOIN animalvaccination ON animalvaccination.animalid = animal.id
WHERE $RECORD_RABIES_NUM$ = 'Yes'
  AND animalvaccination.vaccinationid IN ($RABIES_IDS$)
  AND animalvaccination.DateofVaccination IS NOT NULL
  AND animalvaccination.RabiesTag = ''
  AND date_trunc('day', animalvaccination.LastChangedDate) = '$CURRENT_DATE-1$'
  AND animal.nonshelteranimal = 0
  
--#A056. Checks to see if required vaccination is missing.  Added 6/30/2023
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.DateBroughtIn) AS issuedate,
  '<font color = "red">Vaccination issue.  No required vaccinations. Alerts only once. (A056)</font>'  AS ISSUE 
FROM animal
INNER JOIN Species ON Species.ID = animal.SpeciesID
WHERE NULLIF(regexp_replace('$REQUIRED_VACCINE_IDS$', '\D','','g'), '')::numeric > 0
  AND animal.Archived = 0
  AND EXTRACT(days FROM animal.datebroughtin - animal.dateofbirth) >= 44 -- at 6 weeks
  AND Species.SpeciesName IN ('Dog','Cat')
  AND date_trunc('day',animal.DateBroughtIn) = Current_Date - $REQUIRED_VACC_DAYS$
  AND NOT EXISTS(SELECT av.ID FROM animalvaccination av
    WHERE av.AnimalID = animal.ID 
    AND av.VaccinationID IN ($REQUIRED_VACCINE_IDS$))

--#A057. Reports when Entry Type indicates Owner Surrender, but no owner entered in Original Owner field.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'No Owner in <i>Original Owner</i> field in Entry Section even though designated surrender in Entry Type. <font color = "Red">Alerts for 3 days Only.</font> (A057)' AS issue
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $USE_ENTRY_TYPE$ = 'Yes'
  AND date_trunc('day', animal.DateBroughtIn) > '$CURRENT_DATE-3$'
  AND animal.archived=0
  AND animal.originalownerid = 0
  AND animal.entrytypeid = 1
  AND animal.reasonno = '' -- make sure a Reason not from owner wasn't entered
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A058. Transfer In Entry Type, check to see if there is a person in the 'Transferred From' field in the Entry Section. Added 1/9/2024
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode AS code,
  date(animal.LastChangedDate) AS issuedate,
  'Transfer In Issue. Marked <i>Transfer In</i>, but no person in <i>Transferred From</i> field in Entry section. <font color = "Red">Alerts for 3 days Only.</font> (A058)' AS issue 
FROM animal
INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $USE_ENTRY_TYPE$ = 'Yes'
  AND date_trunc('day', animal.DateBroughtIn) > '$CURRENT_DATE-3$'
  AND animal.nonshelteranimal = 0
  AND animal.broughtinbyownerid = 0
  AND animal.entrytypeid = 3
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A059. Alerts if Entry Category set to Transfer from but 'Transfer In' Entry Type not selected. Added 1/10/24
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
  'Transfer In issue. A <i>Transfer</i> Entry Category selected, but <i>Transfer In</i> Entry Type not selected in Entry Section. <font color = "red">Alerts Only Once.</font> (A048)' AS issue 
FROM animal
   INNER JOIN entryreason ON entryreason.ID = animal.EntryReasonID
WHERE $TRANSFER_IN_CATEGORY$ = 'Yes'
  AND $USE_ENTRY_TYPE$ = 'Yes'
  AND date_trunc('day', animal.DateBroughtIn) = '$CURRENT_DATE-1$'
  AND animal.nonshelteranimal = 0
  AND animal.archived = 0
  AND animal.entrytypeid <> 3
  AND animal.entryreasonid IN ($TRANSFER_IN_IDS$)
  AND NOT (animal.AdditionalFlags LIKE 'Ignore Issues|%' OR animal.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#A060. DOA Entry Type selected without DOA checkbox.  Added 4/12/24
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.sheltercode as code,
  date(animal.LastChangedDate) as issuedate,
    '<font color = "red">Death issue.  <i>Dead on arrival</i> Entry Type and DOA Checkbox should match. Alerts for 30 days. (A060)</font>' AS issue
FROM animal
WHERE animal.LastChangedDate  > '$CURRENT_DATE-30$'
  AND NonShelterAnimal = 0
  AND DECEASEDDATE is not null
  AND (animal.IsDOA = 1 AND animal.EntryTypeID <> 9
  OR animal.IsDOA = 0 AND animal.EntryTypeID = 9)

--#A061. Compares cost values in Vaccination Type tables against those in Animal Templates to make sure they match.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/animal?id='||animal.ID||'" target="_'||$OPEN_IN_TAB$||'">'||animal.AnimalName||'</a>' AS name,
  animal.ShelterCode as code,
  date(av.LastChangedDate) as issuedate,
  '<font color = "red">Vaccination cost issue.  Vaccination cost in <i>Settings>Lookup data>Vaccination Types</i> do not match costs in Template Animal. Alerts Only Once.</font> (A061)' AS issue
FROM animalvaccination av
  INNER JOIN animal ON animal.ID = av.AnimalID
  INNER JOIN vaccinationtype vt ON vt.ID = av.VaccinationID
WHERE av.VaccinationID = vt.ID
  AND av.Cost <> vt.DefaultCost
  AND date_trunc('day', av.LastChangedDate) = '$CURRENT_DATE-1$'
  AND animal.AnimalName like 'Template%'

--****************************************************************************************************************************************************************************************
--***  PERSON SECTION  *******************************************************************************************************************************************************************
--****************************************************************************************************************************************************************************************

--#P001. This alerts when banned people also do not have the Exclude from bulk mailings flag.
--You want to make sure that you do not email or mail users that have been banned.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS Name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color = "red">Banned Person without <i>Exclude from bulk mailings</i> Flag.  Alerts Only Once. (P001)</font>' AS issue  
FROM owner
WHERE date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND isbanned = 1
  AND excludefrombulkemail = 0

--#P002. Checks to see if first name is missing on person records tagged as 'Individuals'.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">First Name is blank.  Possible Organization. Alerts Only Once. (P002)</font>' AS issue
FROM owner
WHERE ownerforenames = ''
  AND ownertype = 1
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'

--#P003. Checks to see if there is a firstname on an Organization Record. 
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">First Name should be blank.  Change to Individual, clear First Name field, change back to Organization, and then re-Save. Alerts Only Once. (P003)</font>' AS issue
FROM owner
WHERE ownerforenames <> ''
  AND ownertype = 2
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'

--#P004. Checks for ownercodes that start with XX, which means last name field is missing.
  UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">Possible invalid Last Name or Organization Name. Alerts Only Once. (P004)</font>' AS issue
FROM owner
WHERE ownercode like 'XX%'
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  
--#P005. Checks for Capitalization issues in first and last name fields.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">Capitalization issue in name field. Alerts Only Once. (P005)</font>' AS issue
FROM owner
WHERE $CAPITALIZATION_RULES$ = 'Yes'
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
AND ((LOWER(ownerforenames) = ownerforenames AND LENGTH(NULLIF(regexp_replace(ownerforenames, '[^a-zA-Z]','','g'), '')) <> 2)
       OR (UPPER(ownerforenames) = ownerforenames AND LENGTH(NULLIF(regexp_replace(ownerforenames, '[^a-zA-Z]','','g'), '')) <> 2)
       OR (LOWER(ownerforenames2) = ownerforenames2 AND LENGTH(NULLIF(regexp_replace(ownerforenames2, '[^a-zA-Z]','','g'), '')) <> 2)
       OR (UPPER(ownerforenames2) = ownerforenames2 AND LENGTH(NULLIF(regexp_replace(ownerforenames2, '[^a-zA-Z]','','g'), '')) <> 2)
       OR (LOWER(ownersurname) = ownersurname AND ownersurname <> '')
       OR (UPPER(ownersurname) = ownersurname AND ownersurname <> '')
       OR (LOWER(ownersurname2) = ownersurname2 AND ownersurname2 <> '')
       OR (UPPER(ownersurname2) = ownersurname2 AND ownersurname2 <> ''))
   AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%') 

--#P006. Checks to see if last name for second person on Couple is blank.  Needed for duplicate person search.  Added 2023-09-05
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">Last Name is blank on second person (Couple). Alerts Only Once. (P006)</font>' AS issue
FROM owner
WHERE ownersurname2 = ''
  AND ownertype = 3
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'

--#P007. Checks for extra spaces in address field.  Extra spaces will cause address searches to not find results.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">Extra spaces in address field. Alerts Only Once. (P007)</font>' AS issue
FROM owner
WHERE SUBSTR(owner.owneraddress,1,8) like '%  %'
AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P008. This alert shows if North, South, East, West, etc.
--It is important to stardardized entry of addresses so that this script can detect possible address duplications.    Added 11/18/2021
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  current_date -1 AS issuedate,
  '<font color = "Red">Possible address standardization issue (' || owner.owneraddress || ').  North, South, First, etc.  Change to N., S., 1st, if needed. Alerts Only Once. (P008)</font>' AS issue
FROM owner
where date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND (SUBSTR(UPPER(owneraddress),1,12) LIKE '% NORTH %'
     OR SUBSTR(UPPER(owneraddress),1,12) LIKE '% SOUTH %'
     OR SUBSTR(UPPER(owneraddress),1,11) LIKE '% EAST %'
     OR SUBSTR(UPPER(owneraddress),1,11) LIKE '% WEST %'
     OR SUBSTR(UPPER(owneraddress),1,14) LIKE '% HIGHWAY %'
     OR SUBSTR(UPPER(owneraddress),1,12) LIKE '% FIRST %'
     OR SUBSTR(UPPER(owneraddress),1,13) LIKE '% SECOND %'
     OR SUBSTR(UPPER(owneraddress),1,12) LIKE '% THIRD %'
     OR SUBSTR(UPPER(owneraddress),1,13) LIKE '% FOURTH %'
     OR SUBSTR(UPPER(owneraddress),1,12) LIKE '% FIFTH %'
     OR SUBSTR(UPPER(owneraddress),1,12) LIKE '% SIXTH %')

--#P009. Checks for commonly misspelled street names.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color="red">Street name misspelled. Alerts Only Once. (P009)</font>' AS issue
FROM owner
WHERE split_part(trim(regexp_replace(owner.owneraddress, '[^[:alpha:]\s]', '', 'g')),' ',1) IN ($COMMON_STREET_MISSPELLINGS$)
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
 AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')  
  
--#P010. Checks for cities entered in ALL upper or lower case.  
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color = "Red">City capitalization invalid. Alerts Only Once. (P010)</font>' AS issue  
FROM owner
WHERE ownertown <> ''
  AND ownertown NOT IN ($CITY_ALLOWED$)
  AND ((upper(ownertown) = ownertown OR lower(ownertown) = ownertown)
  OR SUBSTR(split_part(ownertown, ' ', 2),1,1) ~ '[a-z]')
    AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$' 
 AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P011. Checks for common misspellings of city.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  'City name misspelled. (P011)' AS issue
FROM owner
WHERE ownertown IN ($COMMON_CITY_MISSPELLINGS$)
 AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')  

--#P012. Checks for cities entered with a comma.  Added 11/5/2021
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  current_date -1 AS issuedate,
  '<font color = "Red">Possible city issue.  Comma in City field. Alerts Only Once. (P012)</font>' AS issue
FROM owner
WHERE ownertown LIKE '%,%'
AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'

--#P013. Checks for invalid state abbreviations.  Ignores State check if there is data in the Country
--field.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  'State abbreviation invalid. (P013)' AS issue
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND owner.OwnerTown <> ''
  AND (owner.OwnerCountry LIKE 'US%' OR owner.OwnerCountry LIKE 'United States%' OR owner.OwnerCountry = '')  -- skip check if foreign county
  AND owner.OwnerCounty NOT IN ('AK', 'AL', 'AR', 'AS', 'AZ', 'CA', 'CO', 'CT', 'DC', 'DE', 'FL', 'GA', 'GU', 'HI', 'IA', 'ID', 'IL', 'IN', 'KS', 'KY', 'LA', 'MA', 'MD', 'ME', 'MI', 'MN', 'MO', 'MP', 'MS', 'MT', 'NC', 'ND', 'NE', 'NH', 'NJ', 'NM', 'NV', 'NY', 'OH', 'OK', 'OR', 'PA', 'PR', 'RI', 'SC', 'SD', 'TN', 'TX', 'UM', 'UT', 'VA', 'VI', 'VT', 'WA', 'WI', 'WV', 'WY')
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P014. Notifies missing zipcode when the address, city, and state have been entered.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color="red">Zipcode missing. Alters Only Once. (P014)</font>' AS issue
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND NOT owner.OwnerAddress = '' 
  AND NOT owner.OwnerTown = '' 
  AND NOT owner.OwnerCounty = '' 
  AND owner.ownerpostcode = ''
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P015. Alerts when zipcode does not match pattern.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color="red">Zipcode invalid. Alters Only Once. (P015)</font>' AS issue
FROM owner
WHERE date_trunc('day', owner.LastChangedDate) = '$CURRENT_DATE-1$'
  AND owner.ownerpostcode <>  ''
  AND (($COUNTRY$ = 'USA'
    AND owner.OwnerCounty = $STATE_ABBREVIATION$
    AND SUBSTR(owner.ownerpostcode,1,1) <> $ZIPCODE_STARTING_DIGIT$)
  OR
   ($COUNTRY$ = 'UK'
     AND owner.OwnerPostcode NOT SIMILAR TO '[A-Z]{1,2}([0-9]{1,2}|[0-9][A-Z])\s[0-9][A-Z]{2}'))

--#P016. Alerts when zipcode length doesn't match 5 or 10.  Added 7/16/2021
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
  '<font color="red">Zipcode length invalid. Alters Only Once. (P016)</font>' AS issue
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND ownerpostcode <>  '' 
  AND LENGTH(ownerpostcode) not in (5,10)
  AND ownerpostcode < 'a' -- Only look at numbers.
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P017. Checks for Countries entered in lower case.  And common misspellings of Country names. Added 5/14/2022
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) as issuedate,
  '<font color="red">Country or Country capitalization invalid. Alters Only Once. (P017)</font>' AS issue
FROM owner
WHERE ownercountry <> ''
  AND date_trunc('day', owner.LastChangedDate) = '$CURRENT_DATE-1$'
 AND (lower(ownercountry) = ownercountry
 OR ownercountry in ($COMMON_COUNTRY_MISSPELLINGS$))

--#P018. This strips out all characters and then alerts if phone number is not equal to 10 or 11 (in case someone enters a 1 in front of area code)
--characters.  It will ignore this if two phone numbers are in same field but separated
--by a slash (/).  Updated 4/24/2023 for 2nd contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color="red">Phone number length invalid. If combining two, separate with /. Alters Only Once. (P018)</font>' AS issue
FROM owner
WHERE (($COUNTRY$ = 'USA'
    AND (LENGTH(NULLIF(regexp_replace(hometelephone, '\D','','g'), '')) NOT IN (10,11) 
    OR LENGTH(NULLIF(regexp_replace(mobiletelephone, '\D','','g'), '')) NOT IN (10,11)
    OR LENGTH(NULLIF(regexp_replace(mobiletelephone2, '\D','','g'), '')) NOT IN (10,11))
    AND (hometelephone NOT LIKE '%/%' AND mobiletelephone NOT LIKE '%/%' AND mobiletelephone2 NOT LIKE '%/%'))
  OR
    ($COUNTRY$ <> 'USA'
    AND (LENGTH(NULLIF(regexp_replace(hometelephone, '\D','','g'), '')) NOT IN ($PHONE_DIGITS$) 
    OR LENGTH(NULLIF(regexp_replace(mobiletelephone, '\D','','g'), '')) NOT IN ($PHONE_DIGITS$)
    OR LENGTH(NULLIF(regexp_replace(mobiletelephone2, '\D','','g'), '')) NOT IN ($PHONE_DIGITS$))
    AND (hometelephone NOT LIKE '%/%' AND mobiletelephone NOT LIKE '%/%' AND mobiletelephone2 NOT LIKE '%/%')))
  AND date_trunc('day', owner.LastChangedDate) = '$CURRENT_DATE-1$'
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P019. This strips out all characters and then alerts if phone number is 11 characters and the first character 
--is not a 1 (in case someone enters a 1 in front of area code). Updated 4/24/2023 for 2nd contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color="red">Phone number invalid.  If 11 digits, should begin with <i>1</i>. Alters Only Once. (P019)</font>' AS issue 
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND date_trunc('day', LastChangedDate) = '$CURRENT_DATE-1$'
  AND ((LENGTH(NULLIF(regexp_replace(hometelephone, '\D','','g'), '')) = 11 AND SUBSTRING(regexp_replace(hometelephone, '\D','','g'),1,1) <> '1')
  OR (LENGTH(NULLIF(regexp_replace(mobiletelephone, '\D','','g'), '')) = 11 AND SUBSTRING(regexp_replace(mobiletelephone, '\D','','g'),1,1) <> '1')
  OR (LENGTH(NULLIF(regexp_replace(mobiletelephone2, '\D','','g'), '')) = 11 AND SUBSTRING(regexp_replace(mobiletelephone2, '\D','','g'),1,1) <> '1'))
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')

--#P020. This alert strips out all characters and compares the last 10 digits of mobile and home phone numbers
--for records that were modified the day before. Updated 4/23/2023 to include Couple mobile phone.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
  current_date -1 AS issuedate,
  '<font color = "Red">Phone number duplication - (' || ow.ownercode || ').  Alerts Only Once. (P020)</font>' AS issue
FROM owner o, owner ow
WHERE date_trunc('day', o.LASTCHANGEDDATE)  = '$CURRENT_DATE-1$'
  AND ow.IsDeceased = 0
  AND o.id <> ow.id
AND ((regexp_replace(o.hometelephone, '\D','','g') <> '' AND RIGHT(regexp_replace(o.hometelephone, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.hometelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.hometelephone <> '')
   OR (regexp_replace(o.hometelephone, '\D','','g') <> '' AND RIGHT(regexp_replace(o.hometelephone, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.mobiletelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.mobiletelephone <> '')
   OR (regexp_replace(o.hometelephone, '\D','','g') <> '' AND RIGHT(regexp_replace(o.hometelephone, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.mobiletelephone2, '\D','','g'),$PHONE_DIGITS$) AND ow.mobiletelephone2 <> '')   
   OR (regexp_replace(o.mobiletelephone, '\D','','g') <> '' AND RIGHT(regexp_replace(o.mobiletelephone, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.mobiletelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.mobiletelephone <> '')
   OR (regexp_replace(o.mobiletelephone, '\D','','g') <> '' AND RIGHT(regexp_replace(o.mobiletelephone, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.hometelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.hometelephone <> '')
   OR (regexp_replace(o.mobiletelephone2, '\D','','g') <> '' AND RIGHT(regexp_replace(o.mobiletelephone2, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.hometelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.hometelephone <> '')
   OR (regexp_replace(o.mobiletelephone2, '\D','','g') <> '' AND RIGHT(regexp_replace(o.mobiletelephone2, '\D','','g'),$PHONE_DIGITS$) LIKE RIGHT(regexp_replace(ow.mobiletelephone, '\D','','g'),$PHONE_DIGITS$) AND ow.mobiletelephone <> ''))
  AND NOT ((lower(o.comments) like 'see%' OR lower(o.comments) like '%see%') AND (lower(ow.comments) like 'see%' OR lower(ow.comments) like '%see%'))

--#P021. Looks for invalid email addresses missing @ or .  Updated 4/24/2023 for 2nd Contact.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.CreatedDate) as issuedate,
  '<font color="red">Email invalid. Alerts Only Once. (P021)</font>' AS issue
FROM owner
WHERE (((owner.EmailAddress NOT LIKE '%@%' OR owner.EmailAddress NOT LIKE '%.%') AND owner.EmailAddress <> '')
  OR ((owner.EmailAddress2 NOT LIKE '%@%' OR owner.EmailAddress2 NOT LIKE '%.%') AND owner.EmailAddress2 <> ''))
  AND date_trunc('day', owner.CreatedDate) = '$CURRENT_DATE-1$'

--#P022. This alert compares the email of records that were modified the day before with emails
--in the database.  Updated 4/23/2023 to search on 2nd contact email.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
   current_date -1 AS issuedate,
 '<font color = "Red">Email address duplication (' || ow.ownercode || ').  Alerts Only Once. (P022)</font>' AS issue
FROM owner o, owner ow
WHERE date_trunc('day', o.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND ow.IsDeceased = 0
  AND o.ID <> ow.ID
  AND ((o.emailaddress <> '' AND lower(o.emailaddress) LIKE lower(ow.emailaddress))
      OR (o.emailaddress <> '' AND lower(o.emailaddress) LIKE lower(ow.emailaddress2))
      OR (o.emailaddress2 <> '' AND lower(o.emailaddress2) LIKE lower(ow.emailaddress))
      OR (o.emailaddress2 <> '' AND lower(o.emailaddress2) LIKE lower(ow.emailaddress2)))

--#P023. This alert if the @ sign appears in the phone number fields.  Updated 4/23/2023 to search on 2nd contact email.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) as issuedate,
 '<font color = "Red">Email address in wrong field (Possible).  Alerts Only Once. (P023)</font>' AS issue
FROM owner
WHERE date_trunc('day', owner.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND (owner.hometelephone LIKE '%@%' 
  OR owner.mobiletelephone LIKE '%@%'
  OR owner.worktelephone LIKE '%@%' 
  OR owner.mobiletelephone2 LIKE '%@%'
  OR owner.IdentificationNumber LIKE '%@%'
  OR owner.IdentificationNumber2 LIKE '%@%')

--#P024. Looks for invalid email address domains.  Modified 4/23/2023 to search on 2nd contact email.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode as code,
  date(owner.LastChangedDate) as issuedate,
  '<font color = "Red">Email domain invalid (Possible). Alerts Only Once. (P024)</font>' AS issue
FROM owner
WHERE date_trunc('day', owner.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'                 
  AND ((owner.OwnerType = 3
        AND owner.EmailAddress2 <> ''
        AND lower(regexp_replace(owner.EmailAddress2, '.+\.(.+)', '\1')) NOT IN ($DOMAINS$))
      OR
      (owner.EmailAddress <> ''
        AND lower(regexp_replace(owner.EmailAddress, '.+\.(.+)', '\1')) NOT IN ($DOMAINS$)))

--#P025. Looks for special characters that will affect searches.  Added 7/16/2021. Updated 4/23/2023 to search on 2nd Contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color = "Red">Invalid character (such as  or -).  Type over and re-Save. Alerts Only Once.  (P025)</font>' AS issue  
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND date_trunc('day', owner.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND (ownerforenames like '%&#%' OR ownerforenames2 like '%&#%' 
  OR ownersurname like '%&#%' OR ownersurname2 like '%&#%'
  OR owneraddress like '%&#%' OR ownertown like '%&#%'
  OR ownercounty like '%&#%')

--#P026. Alerts when the license expiration date compared to the issue date is less than 335 days
--or expiration date is less than issue date. Not in main SQL.
--UNION SELECT 
--  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
--  owner.ownercode AS code,
--  date(ol.LastChangedDate) AS issuedate,
--  '<font color = "Red">Invalid License Expiration Date. Alerts Only Once. (P026)</font>' AS issue
--FROM ownerlicence ol
--  INNER JOIN owner ON owner.ID = ol.OwnerID
--WHERE (extract(days from ol.ExpiryDate - ol.ISSUEDATE) < 335
--  OR ol.ExpiryDate < ol.ISSUEDATE)
--  AND date_trunc('day', ol.IssueDate) = '$CURRENT_DATE-1$'

--#P027. This looks at the comments field of citation to see if the different ordinance numbers have
--been entered.  This allows for reporting of individual ordinance violations if needed.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  oc.CreatedDate AS issuedate,
 '<font color="red">Missing citation number(s) in Comments. Alerts Only Once. (P027)</font>' AS issue
FROM ownercitation oc
INNER JOIN citationtype ct ON ct.ID = oc.CitationTypeID
INNER JOIN owner ON owner.ID = oc.OwnerID 
WHERE $CITATION_NUMBERS$ = 'Yes'
  AND date_trunc('day', oc.CreatedDate) = '$CURRENT_DATE-1$' 
  AND oc.comments = ''

 --#P028. If person designated as Member, checks for membership expiration date.
UNION SELECT 
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
    'Missing Membership Flag or Date. (P028)' AS issue
FROM owner
WHERE $MEMBERSHIP_EXPIRATION$ = 'Yes'
  AND(ismember = 1 AND owner.MEMBERSHIPEXPIRYDATE IS NULL) 
  OR (ismember = 0 AND owner.MEMBERSHIPEXPIRYDATE > current_date)

--#P029. Notifies when an online form is attached to a person who is already in the system.
UNION SELECT DISTINCT
    '<a href="'||$SERVER_URL$||'/'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
  current_date -1 AS issuedate, 
  '<font color = "Red">Online form attached to existing Person record. Compare Last Name field with the data on the NEW online form.  Forms are linked based on First Name match AND cell or email match.  Last Name field is not auto updated. Alerts Only Once. (P029)</font>' AS issue
FROM owner o
INNER JOIN media m ON m.linkid = o.ID
WHERE  date_trunc('day', m.date) = '$CURRENT_DATE-1$'
  AND m.medianotes NOT LIKE '%.html%'
  AND m.MediaMimeType = 'text/html'
  AND m.linktypeid = 3
  AND cast(o.CreatedDate AS DATE) < cast(m.date AS DATE)   

--#P030. Reports if person added day before is not linked to any records and has no flags.
--Suspect that when modifying a person link, ASM does not warn if leaving before saving.
UNION SELECT DISTINCT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
  date(o.LastChangedDate) as issuedate,
  '<font color = "Red">Person record added but NOT LINKED to any records and has no Flags.  Alerts Only Once. (P030)</font>' AS issue
FROM owner o
WHERE date_trunc('day', o.createddate) = '$CURRENT_DATE-1$'
AND (o.additionalflags = '|' OR o.additionalflags = '')
AND NOT EXISTS(SELECT ID FROM adoption WHERE OwnerID = o.ID OR ReturnedByOwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animal WHERE OriginalOwnerID = o.ID OR BroughtInByOwnerID = o.ID OR OwnerID = o.ID OR CurrentVetID = o.ID OR OwnersVetID = o.ID 
    OR AdoptionCoordinatorID = o.ID OR NeuteredByVetID = o.ID)
AND NOT EXISTS(SELECT ID FROM additional WHERE CAST(VALUE AS int) = o.ID AND AdditionalFieldID IN ($ADDITIONAL_FIELDS$))
AND NOT EXISTS(SELECT ID FROM animalboarding WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animalcontrol WHERE VictimID = o.ID OR CallerID = o.ID OR OwnerID = o.ID OR Owner2ID = o.ID OR Owner3ID = o.ID)
AND NOT EXISTS(SELECT ID FROM animalfound WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animallost WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animalwaitinglist WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animaltransport WHERE DriverOwnerID = o.ID OR PickupOwnerID = o.ID OR DropoffOwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM animalmedicaltreatment WHERE AdministeringVetID = o.ID)
AND NOT EXISTS(SELECT ID FROM animaltest WHERE AdministeringVetID = o.ID)
AND NOT EXISTS(SELECT ID FROM animalvaccination WHERE AdministeringVetID = o.ID)
AND NOT EXISTS(SELECT ID FROM clinicappointment WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM event WHERE EventOwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM log WHERE LinkID = o.ID AND LinkType = 1)
AND NOT EXISTS(SELECT ID FROM media WHERE media.LinkID = o.ID AND media.LinkTypeID = 3) 
AND NOT EXISTS(SELECT ID FROM ownercitation WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownerdonation WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownerinvestigation WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownerlicence WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownerlookingfor WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownerrota WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownertraploan WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM ownervoucher WHERE OwnerID = o.ID)
AND NOT EXISTS(SELECT ID FROM users WHERE OwnerID = o.ID)

--#P031. This searches for partial address and last name match. Updated 4/23/2023 to search on 2nd Contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode as code,
  date(o.LastChangedDate) as issuedate,
 '<font color = "Red">Possible duplicate Person record - (' || ow.ownercode || ').  Partial address and last or first name match. Alerts Only Once. (P031)</font>' AS issue
FROM owner o, owner ow
where date_trunc('day', o.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND ow.IsDeceased = 0
AND LOWER(REGEXP_REPLACE(ow.owneraddress, '[^0-9A-Za-z]', '','g')) LIKE SUBSTR(LOWER(REGEXP_REPLACE(o.owneraddress, '[^0-9A-Za-z]', '','g')),1,8) || '%'
AND LENGTH(o.owneraddress) > 8
AND ((LOWER(o.ownersurname) = LOWER(ow.ownersurname) AND ow.ownersurname <> '')
   OR (LOWER(o.ownersurname) = LOWER(ow.ownersurname2) AND ow.ownersurname2 <> '')
   OR (LOWER(o.ownersurname2) = LOWER(ow.ownersurname) AND ow.ownersurname <> '')
   OR (LOWER(o.ownersurname2) = LOWER(ow.ownersurname2) AND ow.ownersurname2 <> '')
   OR (LOWER(o.ownerforenames) = LOWER(ow.ownerforenames) AND ow.ownerforenames <> '')
   OR (LOWER(o.ownerforenames) = LOWER(ow.ownerforenames2) AND ow.ownerforenames2 <> '')
   OR (LOWER(o.ownerforenames2) = LOWER(ow.ownerforenames) AND ow.ownerforenames <> '')
   OR (LOWER(o.ownerforenames2) = LOWER(ow.ownerforenames2) AND ow.ownerforenames2 <> ''))
 AND o.id <> ow.id 
 AND NOT ((lower(o.comments) like 'see%' OR lower(o.comments) like '%see%') AND date_trunc('day', o.LASTCHANGEDDATE) = current_date -1)

--#P032.  Checks for Duplicate First and Last Names.  Added 1/24/2023. Updated 4/23/2023 to search on 2nd Contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
  date(o.LastChangedDate) AS issuedate,
  '<font color = "Red">Possible duplicate Person record - (' || ow.ownercode || ').  First and Last Name Match. Alerts Only Once. (P032)</font>' AS issue
FROM owner o, owner ow
WHERE date_trunc('day', o.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND ow.IsDeceased = 0
  AND o.id <> ow.id
  AND ((LOWER(o.ownersurname) = LOWER(ow.ownersurname) AND (LOWER(o.ownerforenames) = LOWER(ow.ownerforenames) AND ow.ownerforenames <> ''))
   OR (LOWER(o.ownersurname) = LOWER(ow.ownersurname2) AND (LOWER(o.ownerforenames) = LOWER(ow.ownerforenames2) AND ow.ownerforenames2 <> ''))
   OR (LOWER(o.ownersurname2) = LOWER(ow.ownersurname) AND (LOWER(o.ownerforenames2) = LOWER(ow.ownerforenames) AND ow.ownerforenames <> ''))
   OR (LOWER(o.ownersurname2) = LOWER(ow.ownersurname2) AND (LOWER(o.ownerforenames2) = LOWER(ow.ownerforenames2) AND ow.ownerforenames2 <> '')))
  AND lower(o.ownersurname) NOT IN ('jackson','johnson','jones','smith','white','williams','unknown','caller')

--#P033.  Checks for Duplicate IDNumber (Drivers License).  Added 1/24/2023. Updated 4/23/2023 to search on 2nd Contact.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||o.ID||'" target="_'||$OPEN_IN_TAB$||'">'||o.OwnerName||'</a>' AS name,
  o.ownercode AS code,
  date(o.LastChangedDate) AS issuedate,
  'ID Number duplicate (' ||  ow.ownercode || '). (P033)' as issue
FROM owner o, owner ow
WHERE o.id <> ow.id
  AND date_trunc('day', o.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND LENGTH(o.IdentificationNumber) > 5
  AND ((o.identificationnumber <> '' AND regexp_replace(o.IdentificationNumber, '\D','','g') LIKE regexp_replace(ow.IdentificationNumber, '\D','','g') AND ow.IdentificationNumber <> '')
      OR (o.identificationnumber <> '' AND regexp_replace(o.IdentificationNumber, '\D','','g') LIKE regexp_replace(ow.IdentificationNumber2, '\D','','g') AND ow.IdentificationNumber2 <> '')
      OR (o.identificationnumber2 <> '' AND regexp_replace(o.IdentificationNumber2, '\D','','g') LIKE regexp_replace(ow.IdentificationNumber, '\D','','g') AND ow.IdentificationNumber <> '')
      OR (o.identificationnumber2 <> '' AND regexp_replace(o.IdentificationNumber2, '\D','','g') LIKE regexp_replace(ow.IdentificationNumber2, '\D','','g') AND ow.IdentificationNumber2 <> ''))
  
--#P034. This will alert if an ownertype of 3 (Couple) is used.  Since this is an animal control agency, using the
--Couple feature isn't the best practice since AC's need to be able associate citations/incidents with individuals. 
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) as issuedate,
 '<font color = "Red">Owner Class of <i>Couple</i> was used. Since this is an AC agency who assigns Citations/Incidents, using <i>Couple</i> might not be best practice.  Alerts Only Once. (P034)</font>' AS issue
FROM owner
WHERE $COUPLE_WARN$ = 'Yes'
  AND date_trunc('day', owner.LASTCHANGEDDATE) = '$CURRENT_DATE-1$'
  AND owner.ownertype = 3
  
--#P035. This will alert when a voucher is created without an animal attached.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(ownervoucher.DateIssued) AS issuedate,
'<font color = "Red">Voucher issued (' || ownervoucher.id || ') without animal attached. Alerts Only Once. (P035)</font>'  AS issue
FROM ownervoucher
INNER JOIN voucher ON voucher.ID = ownervoucher.VoucherID
INNER JOIN owner ON owner.ID = ownervoucher.OwnerID
WHERE $VOUCHER_ANIMAL$ = 'Yes'
  AND ownervoucher.AnimalID = 0
  AND date_trunc('day', ownervoucher.DateIssued) = '$CURRENT_DATE-1$'

--****************************************************************************************************************************************************************************************
--***  LOCAL SYSTEM ONLY  ****************************************************************************************************************************************************************
--****************************************************************************************************************************************************************************************

--Looks for common invalid area codes. Updated 4/29/2023 for 2nd Contact.
-- Not in main SQL.
UNION SELECT
  '<a href="'||$SERVER_URL$||'/person?id='||owner.ID||'" target="_'||$OPEN_IN_TAB$||'">'||owner.OwnerName||'</a>' AS name,
  owner.ownercode AS code,
  date(owner.LastChangedDate) AS issuedate,
 '<font color = "Red">Area code invalid. Alerts Only Once.</font>' AS issue   
FROM owner
WHERE $COUNTRY$ = 'USA'
  AND (SUBSTRING(regexp_replace(hometelephone, '\D','','g'),1,3) IN ('510','497','807') --CUSTOMIZATION REQUIRED HERE
  OR SUBSTRING(regexp_replace(worktelephone, '\D','','g'),1,3) IN ('510','497','807') --CUSTOMIZATION REQUIRED HERE
  OR SUBSTRING(regexp_replace(mobiletelephone, '\D','','g'),1,3) IN ('510','497','807') --CUSTOMIZATION REQUIRED HERE
  OR SUBSTRING(regexp_replace(mobiletelephone2, '\D','','g'),1,3) IN ('510','497','807')) --CUSTOMIZATION REQUIRED HERE
  AND date_trunc('day', owner.LASTCHANGEDDATE)  = '$CURRENT_DATE-1$'
  AND NOT (owner.AdditionalFlags LIKE 'Ignore Issues|%' OR owner.AdditionalFlags  LIKE '%|Ignore Issues|%')
   
) dummy
ORDER BY 4,3
###
$$HEADER
<table border=1>
<tr>
<th>ALERT</th>
<th>NAME</th>
<th>CODE</th>
<th>DATE</th>
</tr>
HEADER$$

$$BODY
<tr>
<td>$issue</td>
<td>$name</td>
<td>$code</td>
<td>$issuedate</td>
</tr>
BODY$$

$$FOOTER
</table>
FOOTER$$
